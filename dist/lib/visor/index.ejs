
<!DOCTYPE html>
<html lang="en" style="height: 100%">
<head>
<meta charset="UTF-8">
<title>Dali - POC</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<link rel="stylesheet" href="css/style.css">
<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="css/textStyles.css">
<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="lib/jquery-ui.min.js"></script>
<script src="lib/jquery.ui.touch-punch.min.js"></script>
<script src="lib/api.js"></script>
<script src="lib/ckeditor/ckeditor.js"></script>
<script src="BasePlugin.js"></script>
<script src="plugins.json"></script>
<script src="lib/visor/visor.js"></script>
<body  style="margin: 0px; height: 100%">
<div style="height:100%;" id="editor truevisor">
<div style="height:100%;" id="root" style="height: 100%">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
<div class="outter" style="padding-top:0px;">
<div id="maincontent" class="slide <%=navs[page].type == 'slide' ? 'sli':'doc'%>" style="visibility: visible;" >
<div style="visibility: visible; overflow: auto;" class="caja">
<% 
      var padre = navs[navs[page].parent].name || 'Section 0';
      var patt = /([0-9]+((\.[0-9]+)+)?)/;  //Detecta número de sección. Ej. Section (2.3.4.2)
      var sectiontitle = patt.exec(padre)? patt.exec(padre)[0]:'0';
%>
<div class="cab"> 
      <div class="cabtabla_numero"><%=sectiontitle%></div>
      <div class="tit_ud_cap">
        <h1> Título Curso -  <%strDate%></h1>
        <h2>Título Unidad</h2>
      </div>
      <div class="cabtabla_lapiz">
        <img src="images/ico_alumno.gif" alt="Alumno"><div id="alumno"> Alumno</div>
      </div>
      <div class="clear"></div>
</div>

<div class="contenido" style="height:auto;">
<h3><%=padre%></h3>
<h4><%=navs[page].name%></h4> 
<div class="boxes" style="position:relative;">

<!--Camel Case -->
<%function camel(s) {
    return s.split(/(?=[A-Z])/).join('-').toLowerCase();
}%>

<!-RENDER CHILDREN->
<% function renderChildren(id, markup, key){
    var component;
    var props = {};
    var children;
    console.log("Render children")
    console.log(id)
    console.log(key)
    console.log(markup)
    console.log("Render logs")
    switch (markup.node) {
      case 'element':
      console.log("case element")
          if(markup.attr){
            console.log("if1")
              console.log(markup.attr)
              props = markup.attr;
          }
          props.key = key;


          if(markup.tag === 'plugin'){
                        console.log("if2")
              pluginplaceholder(props, markup.attr["plugin-data-id"], id)
             
          }else{
              component = markup.tag;
              var properties =""
              for (prop in props){
                 var value = props[prop]
              if (prop == "style"){
                value=""
                for (style in props[prop]){
                  value+= style +":"+camel(props[prop][style])+"; "
                }
              }
                properties +=prop +"=\""+value+"\" "
          }
              
           %>
             <%="<"+component +" " %><%=properties%><%=">"%>
               <%  if (markup.child) {
                       markup.child.forEach((child, index) => {
                          renderChildren(id, child, index);
                       });
                   }

                 %>
             </<%=component%> >

          <%
            }
            break;
      case 'text':
          component = "span";
        %>
          <span>
             <%  if (markup.child) {
                     
                     markup.child.forEach((child, index) => {
                        renderChildren(id,child, index);
                     });
                 }

               %>
          </span>

        <%

          break;
      case 'root':
           
          %>
          <div style="width:100%; height:100%;">
             <%  if (markup.child) {
                     
                     markup.child.forEach((child, index) => {
                        renderChildren(id, child, index);
                     });
                 }

               %>
          </div>

        <%
          break;
    }

    
  };
%>
<!-VISORDALIBOX->
<% function dalibox(id) {
        var borderSize = 2;
        var cornerSize = 15;
        var box = boxesById[id];
        var toolbar =  toolbarsById[id];
        var style = "width: 100%; height: 100%; position: relative; wordWrap: break-word;";
        var attrs = " ";
        console.log('dalibox')
        if(toolbar.buttons) {
            toolbar.buttons.map((item, index) => {
                if (item.autoManaged) {
                    if (!item.isAttribute) {
                        if(item.name !== 'width' && item.name !== 'height') {
                            style += " " + item.name + " : " + item.value;
                            if (item.units)   style += item.units;
                            style+="; ";
                        }
                    } else {
                        attrs += 'data-' + item.name +"= " + item.value +" "
                    }
                }
                
            });
        };
 
        
      
%>
    
  <div className="wholebox" 
       style="
          position:absolute;
          left: <%=box.position.x%>px;
          top: <%=box.position.y%>px;
          width: <%= box.width %>px;
          height: <%=box.height%>px;
          maxWidth: 100%;
          maxHeight: 100%;
          touchAction: none;
          msTouchAction: none;
          cursor:  default ;"  >
   
        <div style="<%= style%>"  <%= attrs%> >
          <%  renderChildren(id, box.content ); %>
        </div>

  </div>
 <%
    }
%>


<!--PLUGIN PLACEHOLDER -->
<%
    function pluginplaceholder(props, pluginContainer, parentBox) {
      console.log('pp')
        let container = boxesById[parentBox].sortableContainers[pluginContainer];
     %>
 <div style=" width: 100%; height: 100%; position: relative;" class="<%= pluginContainer%>" >

     <% if (container){ 
        container.colDistribution.map((col, i) => {
            if(container.cols[i]){  %>
             
                    <div  style="width: <%=col%>%; height: 100%; float: left">
                        <%container.cols[i].map((row, j) => { %>
                            <div  style="width: 100%; height: <%=row %>%; position: relative">
                                <%container.children.map((idBox, index) => {
                                    if( boxesById[idBox].col === i && boxesById[idBox].row === j) {
                                       dalibox(idBox )
                                    }
                                })%>
                            </div>

                        <% })%>
                    </div>
                <%
            }
        })

    } else {%>
    <div style="width: 100%;  height: 100%;"> </div>
    <% } %>
 </div>

   <% }

 %>

<% 
   navs[page].boxes.map((id)=>{
        var box = boxesById[id];
        console.log(box)
        if (box.type === 'normal'){ 
          console.log("boxx")
          dalibox(box.id )
         
       }  else if (box.type === 'sortable') {  %>
             <%=    box.id %>                                

    <%    }
})
%>



</div>
</div>
</div>
</div>
</div>
</div>
</div>
<script type="text/javascript">

$(document).ready(function(){
 Dali.Plugins.loadAllAsync().then(values => {
 values.map((id, index) =>{
    Dali.Plugins.get(id).init();
  })
});
}) 
</script>
</body>
</html>